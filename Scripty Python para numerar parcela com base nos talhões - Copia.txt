import arcpy
from collections import defaultdict

class Toolbox(object):
    def __init__(self):
        self.label = "Toolbox Contador e Exclusor"
        self.alias = "contador_exclusor"
        self.tools = [ContadorExclusor]

class ContadorExclusor(object):
    def __init__(self):
        self.label = "Contar Parcelas e Marcar Exclus√£o"
        self.description = "Conta as parcelas por Index e marca quais manter com base na regra do autoIncrement."
        self.canRunInBackground = False

    def getParameterInfo(self):
        param0 = arcpy.Parameter(
            displayName="Feature Class de Entrada",
            name="fc",
            datatype="DEFeatureClass",
            parameterType="Required",
            direction="Input"
        )
        return [param0]

    def execute(self, parameters):
        fc = parameters[0].valueAsText
        campo_index = "Index"
        campo_contador = "CONTADOR"
        campo_manter = "MANTER"

        contagens = defaultdict(int)
        with arcpy.da.SearchCursor(fc, [campo_index]) as cursor:
            for row in cursor:
                contagens[row[0]] += 1
        maximo_geral = max(contagens.values())
        with arcpy.da.UpdateCursor(fc, [campo_index, campo_contador, campo_manter]) as cursor:
            for row in cursor:
                idx = row[0]
                count = contagens[idx]
                row[1] = count                      
                row[2] = self.autoIncrement(count, maximo_geral)  
                cursor.updateRow(row)

    def autoIncrement(self, parcela, count):
        parcela = int(parcela)
        count = int(count)
        if count <= 3:
            return 1
        return 1 if parcela % 2 != 0 else 0
