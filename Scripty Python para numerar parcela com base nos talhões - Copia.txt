# -*- coding: utf-8 -*-
import arcpy
from collections import defaultdict

class Toolbox(object):
    def __init__(self):
        self.label = "Toolbox Contador e Exclusor"
        self.alias = "contador_exclusor"
        self.tools = [ContadorExclusor]

class ContadorExclusor(object):
    def __init__(self):
        self.label = "Contar Parcelas e Marcar Exclusão"
        self.description = "Conta as parcelas por Index e marca quais manter com base na regra do autoIncrement."
        self.canRunInBackground = False

    def getParameterInfo(self):
        param0 = arcpy.Parameter(
            displayName="Feature Class de Entrada",
            name="fc",
            datatype="DEFeatureClass",
            parameterType="Required",
            direction="Input"
        )
        return [param0]

    def execute(self, parameters, messages):
        fc = parameters[0].valueAsText
        campo_index = "Index"
        campo_nm_parcela = "nm_parcela"
        campo_contador = "CONTADOR"
        campo_manter = "MANTER"

        contagens = defaultdict(int)

        # Conta quantas vezes cada Index aparece
        with arcpy.da.SearchCursor(fc, [campo_index]) as cursor:
            for row in cursor:
                contagens[row[0]] += 1

        # Encontra o valor máximo de parcelas entre todos os Index
        maximo_geral = max(contagens.values())

        # Atualiza os campos CONTADOR (por Index) e MANTER (regra de exclusão)
        with arcpy.da.UpdateCursor(fc, [campo_index, campo_nm_parcela, campo_contador, campo_manter]) as cursor:
            for row in cursor:
                idx = row[0]
                parcela = row[1]
                count = contagens[idx]

                row[2] = count                      # CONTADOR: quantas parcelas existem no talhão (Index)
                row[3] = self.autoIncrement(parcela, count)  # MANTER: aplica regra de exclusão
                cursor.updateRow(row)

    def autoIncrement(self, parcela, count):
        parcela = int(parcela)
        count = int(count)
        if count <= 3:
            return 1
        return 1 if parcela % 2 != 0 else 0
