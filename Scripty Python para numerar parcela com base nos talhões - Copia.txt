# -*- coding: utf-8 -*-
import arcpy
from collections import defaultdict

class Toolbox(object):
    def __init__(self):
        """Define o nome e alias da toolbox"""
        self.label = "Toolbox Contador e Exclusor"
        self.alias = "contador_exclusor"

        self.tools = [ContadorExclusor]

class ContadorExclusor(object):
    def __init__(self):
        self.label = "Contar Parcelas e Marcar Exclusão"
        self.description = "Conta as parcelas por Index e marca quais manter com base na regra do autoIncrement."
        self.canRunInBackground = False

    def getParameterInfo(self):
        params = []

        param0 = arcpy.Parameter(
            displayName="Feature Class de Entrada",
            name="fc",
            datatype="DEFeatureClass",
            parameterType="Required",
            direction="Input"
        )
        params.append(param0)

        return params

    def isLicensed(self):
        return True

    def updateParameters(self, parameters):
        return

    def updateMessages(self, parameters):
        return

    def execute(self, parameters, messages):
        fc = parameters[0].valueAsText

        campo_index = "Index"
        campo_nm_parcela = "nm_parcela"
        campo_contador = "CONTADOR"
        campo_manter = "MANTER"

        contagens = defaultdict(int)

        # 1. Contar número de parcelas por Index
        with arcpy.da.SearchCursor(fc, [campo_index]) as cursor:
            for row in cursor:
                contagens[row[0]] += 1

        # 2. Atualizar CONTADOR e MANTER
        with arcpy.da.UpdateCursor(fc, [campo_index, campo_nm_parcela, campo_contador, campo_manter]) as cursor:
            for row in cursor:
                idx = row[0]
                parcela = row[1]
                count = contagens[idx]

                row[2] = count
                row[3] = self.autoIncrement(parcela, count)
                cursor.updateRow(row)

    def autoIncrement(self, parcela, count):
        parcela = int(parcela)
        count = int(count)
        if count <= 3:
            return 1
        return 1 if parcela % 2 != 0 else 0
