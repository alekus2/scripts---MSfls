output$download_result <- downloadHandler(
  filename = function() {
    now <- Sys.time()
    data_str <- format(now, "%d-%m-%y_%H.%M")
    paste0("parcelas_", data_str, ".zip")
  },
  content = function(file) {
    req(values$result_points)
    
    # Criar diretório temporário específico para os arquivos shapefile
    temp_dir <- tempdir()
    now <- Sys.time()
    data_str <- format(now, "%d-%m-%y_%H.%M")
    shapefile_dir <- file.path(temp_dir, paste0("parcelas_", data_str))
    dir.create(shapefile_dir)

    # Caminho completo para o shapefile a ser gerado
    shapefile_path <- file.path(shapefile_dir, "parcelas.shp")

    # Escrever o shapefile com os dados gerados
    st_write(values$result_points, dsn = shapefile_path, driver = "ESRI Shapefile", delete_dsn = TRUE)

    # Pegar todos os arquivos relacionados ao shapefile
    shapefile_files <- list.files(
      path = shapefile_dir,
      pattern = "parcelas\\.(shp|shx|dbf|prj|cpg|qpj)$",
      full.names = TRUE
    )

    # Compactar todos os arquivos no zip final
    zip::zipr(zipfile = file, files = shapefile_files, root = shapefile_dir)
  },
  contentType = "application/zip"
)
