library(shiny)
library(sf)
library(stringr)
library(dplyr)
library(zip)

server <- function(input, output, session) {
  
  observeEvent(input$confirmar, {
    output$shape_text <- renderText({
      req(input$shape)
      paste("Upload realizado referente aos talhões:", input$shape$name)
    })
    
    output$recomend_text <- renderText({
      req(input$recomend)
      paste("Upload realizado referente a recomendação de parcelas:", input$recomend$name)
    })
    
    output$parc_exist_text <- renderText({
      if (input$parcelas_existentes_lancar == 1) {
        req(input$parc_exist)
        paste("Upload realizado referente as parcelas já existentes:", input$parc_exist$name)
      } else {
        "Upload de parcelas existentes não realizado."
      }
    })
    
    output$confirmation <- renderText({
      req(input$forma_parcela, input$tipo_parcela, input$distancia_minima)
      paste("Forma Parcela:", input$forma_parcela, 
            "Tipo Parcela:", input$tipo_parcela, 
            "Distância Mínima:", input$distancia_minima)
    })
  })
  
  forma_parcela <- reactive({ input$forma_parcela })
  tipo_parcela  <- reactive({ input$tipo_parcela })
  distancia_minima <- reactive({ input$distancia_minima })
  intensidade_amostral <- reactive({ input$intensidade_amostral })
  
  shape_path <- reactive({
    req(input$shape)
    # descompacta todos os arquivos em tempdir()
    shape_files <- unzip(input$shape$datapath, exdir = tempdir())
    # encontra o .shp corretamente
    shp <- grep("\\.shp$", shape_files, value = TRUE)
    req(shp)  # erro se não encontrou
    shp
  })
  
  shape <- reactive({
    shp_file <- shape_path()
    shp <- st_read(shp_file, quiet = TRUE)
    
    if (input$shape_input_pergunta_arudek == 0) {
      shp <- shp %>%
        rename(
          ID_PROJETO = !!sym(input$mudar_nome_arudek_projeto),
          TALHAO    = !!sym(input$mudar_nome_arudek_talhao),
          CICLO     = !!sym(input$mudar_nome_arudek_ciclo),
          ROTACAO   = !!sym(input$mudar_nome_arudek_rotacao)
        )
    }
    
    shp %>%
      mutate(
        ID_PROJETO = str_pad(ID_PROJETO, 4, pad = "0"),
        TALHAO     = str_pad(TALHAO, 3, pad = "0")
      )
  })
  
  parc_exist_path <- reactive({
    if (input$parcelas_existentes_lancar == 1) {
      req(input$parc_exist)
      parc_files <- unzip(input$parc_exist$datapath, exdir = tempdir())
      shp2 <- grep("\\.shp$", parc_files, value = TRUE)
      req(shp2)
      shp2
    } else {
      "data/parc.shp"
    }
  })
  
  recomend <- reactive({
    if (input$recomendacao_pergunta_upload == 1) {
      req(input$recomend)
      read.csv2(input$recomend$datapath) %>% 
        mutate(
          Projeto = str_pad(Projeto, 4, pad = "0"),
          Talhao  = str_pad(Talhao, 3, pad = "0"),
          Index   = paste0(Projeto, Talhao)
        ) %>%
        rename(Num.parc = N, ID_PROJETO = Projeto, TALHAO = Talhao)
    } else {
      req(shape(), input$recomend_intensidade)
      shp <- shape() %>% st_make_valid()
      shp %>%
        group_by(ID_PROJETO, TALHAO) %>%
        summarise(
          Num.parc = ceiling(sum(st_area(geometry)) / 
                             (10000 * as.numeric(input$recomend_intensidade))),
          .groups = "drop"
        ) %>%
        mutate(
          Num.parc = ifelse(Num.parc < 2, 2, Num.parc),
          Index   = paste0(ID_PROJETO, TALHAO)
        ) %>%
        select(ID_PROJETO, TALHAO, Num.parc, Index) %>%
        as.data.frame()
    }
  })
  
  progress_percentage <- reactiveVal(0)
  values <- reactiveValues(result_points = NULL, process_complete = FALSE)
  
  observeEvent(input$gerar_parcelas, {
    session$sendCustomMessage("hide_completed", "")
    
    result <- process_data(
      shape(),
      recomend(),
      parc_exist_path(),
      forma_parcela(),
      tipo_parcela(),
      distancia_minima(),
      intensidade_amostral(),
      function(p) session$sendCustomMessage("update_progress", p)
    )
    
    if (input$lancar_sobrevivencia == 1) {
      for (idx in unique(result$Index)) {
        rows_ipc <- which(result$Index == idx & result$TIPO_ATUAL == "IPC")
        n_s30 <- round(length(rows_ipc) * 0.3)
        s30_sel <- sample(rows_ipc, n_s30)
        result$TIPO_ATUAL[s30_sel] <- "S30"
        result$STATUS[result$Index == idx & result$TIPO_ATUAL == "IPC"] <- "DESATIVADA"
      }
      for (idx in unique(result$Index)) {
        dt <- result[result$Index == idx, ]
        cnt_s30 <- sum(dt$TIPO_ATUAL == "S30")
        needed <- ifelse(nrow(dt) >= 2, 2, 1) - cnt_s30
        if (needed > 0) {
          more_idx <- which(result$Index == idx & result$TIPO_ATUAL == "IPC")
          sel <- sample(more_idx, needed)
          result$TIPO_ATUAL[sel] <- "S30"
        }
        result$STATUS[result$Index == idx & result$TIPO_ATUAL == "IPC"] <- "DESATIVADA"
      }
    }
    
    result$STATUS[result$TIPO_ATUAL == "S30"] <- "ATIVA"
    values$result_points <- result
    session$sendCustomMessage("show_completed", "")
  })
  
  # ... resto do código permanece igual ...
  
}
